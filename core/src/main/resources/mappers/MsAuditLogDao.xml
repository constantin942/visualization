<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mingshi.skyflying.dao.MsAuditLogDao">
  <resultMap id="BaseResultMap" type="com.mingshi.skyflying.domain.MsAuditLogDo">
    <id column="id" jdbcType="INTEGER" property="id"/>
    <result column="is_delete" jdbcType="TINYINT" property="isDelete"/>
    <result column="gmt_create" jdbcType="TIMESTAMP" property="gmtCreate"/>
    <result column="gmt_modified" jdbcType="TIMESTAMP" property="gmtModified"/>
    <result column="op_time" jdbcType="VARCHAR" property="opTime"/>
    <result column="user_name" jdbcType="VARCHAR" property="userName"/>
    <result column="user_id" jdbcType="INTEGER" property="userId"/>
    <result column="instance_name" jdbcType="VARCHAR" property="instanceName"/>
    <result column="instance_id" jdbcType="INTEGER" property="instanceId"/>
    <result column="ms_schema_name" jdbcType="VARCHAR" property="msSchemaName"/>
    <result column="db_id" jdbcType="INTEGER" property="dbId"/>
    <result column="logic" jdbcType="VARCHAR" property="logic"/>
    <result column="sql_type" jdbcType="VARCHAR" property="sqlType"/>
    <result column="exec_state" jdbcType="VARCHAR" property="execState"/>
    <result column="affect_rows" jdbcType="INTEGER" property="affectRows"/>
    <result column="elapsed_time" jdbcType="INTEGER" property="elapsedTime"/>
    <result column="remark" jdbcType="VARCHAR" property="remark"/>
    <result column="ms_sql" jdbcType="LONGVARCHAR" property="msSql"/>
    <result column="sql_source" jdbcType="LONGVARCHAR" property="sqlSource"/>
    <result column="hash" jdbcType="VARCHAR" property="hash"/>
    <result column="sql_insight_db_user_name" jdbcType="VARCHAR" property="sqlInsightDbUserName"/>
    <result column="sql_insight_user_ip" jdbcType="VARCHAR" property="sqlInsightUserIp"/>
    <result column="application_user_name" jdbcType="VARCHAR" property="applicationUserName"/>
    <result column="global_trace_id" jdbcType="VARCHAR" property="globalTraceId"/>
    <result column="parent_segment_id" jdbcType="VARCHAR" property="parentSegmentId"/>
    <result column="current_segment_id" jdbcType="VARCHAR" property="currentSegmentId"/>
    <result column="operation_name" jdbcType="VARCHAR" property="operationName"/>
    <result column="ms_table_name" jdbcType="VARCHAR" property="msTableName"/>
  </resultMap>
  <sql id="Base_Column_List">
    id
    , is_delete, gmt_create, gmt_modified, op_time, user_name, user_id, instance_name,
    instance_id, ms_schema_name, db_id, logic, sql_type, exec_state, affect_rows, elapsed_time,
    remark,ms_sql, sql_source, hash, sql_insight_db_user_name, sql_insight_user_ip, parent_segment_id, current_segment_id, operation_name, application_user_name, ms_table_name
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List"/>
    from ms_audit_log
    where id = #{id,jdbcType=INTEGER}
  </select>
  <select id="selectByUserName" parameterType="java.util.Map" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List"/>
    from ms_audit_log
    where application_user_name = #{applicationUserName,jdbcType=VARCHAR} order by global_trace_id asc
    <if test="pageNo != null and pageSize != null   ">
      LIMIT #{pageNo},#{pageSize}
    </if>
  </select>
  <select id="selectCount" parameterType="java.util.Map" resultType="java.lang.Long">
    select
    count(id)
    from ms_audit_log
    where application_user_name = #{applicationUserName,jdbcType=VARCHAR}
  </select>
  <select id="selectByHash" parameterType="java.lang.String" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List"/>
    from ms_audit_log
    where hash = #{hash,jdbcType=VARCHAR}
  </select>
  <insert id="insertSelectiveBatch" parameterType="java.util.List">
    insert into ms_audit_log
    ( application_user_name, op_time, user_name, user_id, instance_name, instance_id, ms_schema_name, db_id, logic,
    sql_type, exec_state,
    affect_rows, elapsed_time, remark, ms_sql, sql_source, hash,
    sql_insight_db_user_name, global_trace_id, parent_segment_id, current_segment_id, operation_name, ms_table_name)
    values
    <foreach collection="list" item="item" index="index" separator=",">
      (
      #{item.applicationUserName,jdbcType=VARCHAR},
      #{item.opTime,jdbcType=VARCHAR},
      #{item.userName,jdbcType=VARCHAR},
      #{item.userId,jdbcType=INTEGER},
      #{item.instanceName,jdbcType=VARCHAR},
      #{item.instanceId,jdbcType=INTEGER},
      #{item.msSchemaName,jdbcType=LONGVARCHAR},
      #{item.dbId,jdbcType=INTEGER},
      #{item.logic,jdbcType=VARCHAR},
      #{item.sqlType,jdbcType=VARCHAR},
      #{item.execState,jdbcType=VARCHAR},
      #{item.affectRows,jdbcType=INTEGER},
      #{item.elapsedTime,jdbcType=VARCHAR},
      #{item.remark,jdbcType=VARCHAR},
      #{item.msSql,jdbcType=VARCHAR},
      #{item.sqlSource,jdbcType=VARCHAR},
      #{item.hash,jdbcType=VARCHAR},
      #{item.sqlInsightDbUserName,jdbcType=VARCHAR},
      #{item.globalTraceId,jdbcType=VARCHAR},
      #{item.parentSegmentId,jdbcType=VARCHAR},
      #{item.currentSegmentId,jdbcType=VARCHAR},
      #{item.operationName,jdbcType=VARCHAR},
      #{item.msTableName,jdbcType=VARCHAR}
      )
    </foreach>
    on duplicate key update sql_insight_db_user_name = values(sql_insight_db_user_name),sql_source = values(sql_source)
  </insert>
  <insert id="insertSelectiveBatchNoSqlInsightDbUserName" parameterType="java.util.List">
    insert into ms_audit_log
    ( op_time, user_name, user_id, instance_name, instance_id, ms_schema_name, db_id, logic, sql_type, exec_state,
    affect_rows, elapsed_time, remark, ms_sql, sql_source, hash,application_user_name,global_trace_id,
    parent_segment_id, current_segment_id, operation_name, ms_table_name)
    values
    <foreach collection="list" item="item" index="index" separator=",">
      (
      #{item.opTime,jdbcType=VARCHAR},
      #{item.userName,jdbcType=VARCHAR},
      #{item.userId,jdbcType=INTEGER},
      #{item.instanceName,jdbcType=VARCHAR},
      #{item.instanceId,jdbcType=INTEGER},
      #{item.msSchemaName,jdbcType=LONGVARCHAR},
      #{item.dbId,jdbcType=INTEGER},
      #{item.logic,jdbcType=VARCHAR},
      #{item.sqlType,jdbcType=VARCHAR},
      #{item.execState,jdbcType=VARCHAR},
      #{item.affectRows,jdbcType=INTEGER},
      #{item.elapsedTime,jdbcType=VARCHAR},
      #{item.remark,jdbcType=VARCHAR},
      #{item.msSql,jdbcType=VARCHAR},
      #{item.sqlSource,jdbcType=VARCHAR},
      #{item.hash,jdbcType=VARCHAR},
      #{item.applicationUserName,jdbcType=VARCHAR},
      #{item.globalTraceId,jdbcType=VARCHAR},
      #{item.parentSegmentId,jdbcType=VARCHAR},
      #{item.currentSegmentId,jdbcType=VARCHAR},
      #{item.operationName,jdbcType=VARCHAR},
      #{item.msTableName,jdbcType=VARCHAR}
      )
    </foreach>
    on duplicate key update hash = values(hash)
  </insert>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    delete
    from ms_audit_log
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insertSelective" parameterType="com.mingshi.skyflying.domain.MsAuditLogDo">
    insert into ms_audit_log
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="isDelete != null">
        is_delete,
      </if>
      <if test="gmtCreate != null">
        gmt_create,
      </if>
      <if test="gmtModified != null">
        gmt_modified,
      </if>
      <if test="opTime != null">
        op_time,
      </if>
      <if test="userName != null">
        user_name,
      </if>
      <if test="userId != null">
        user_id,
      </if>
      <if test="instanceName != null">
        instance_name,
      </if>
      <if test="instanceId != null">
        instance_id,
      </if>
      <if test="msSchemaName != null">
        ms_schema_name,
      </if>
      <if test="dbId != null">
        db_id,
      </if>
      <if test="logic != null">
        logic,
      </if>
      <if test="sqlType != null">
        sql_type,
      </if>
      <if test="execState != null">
        exec_state,
      </if>
      <if test="affectRows != null">
        affect_rows,
      </if>
      <if test="elapsedTime != null">
        elapsed_time,
      </if>
      <if test="remark != null">
        remark,
      </if>
      <if test="msSql != null">
        ms_sql,
      </if>
      <if test="sqlSource != null">
        sql_source,
      </if>
      <if test="hash != null">
        hash,
      </if>
      <if test="sqlInsightDbUserName != null">
        sql_insight_db_user_name,
      </if>
      <if test="sqlInsightUserIp != null">
        sql_insight_user_ip,
      </if>
      <if test="applicationUserName != null">
        application_user_name,
      </if>
      <if test="globalTraceId != null">
        global_trace_id,
      </if>
      <if test="parentSegmentId != null">
        parent_segment_id,
      </if>
      <if test="currentSegmentId != null">
        current_segment_id,
      </if>
      <if test="operationName != null">
        operation_name,
      </if>
      <if test="msTableName != null">
        ms_table_name,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=INTEGER},
      </if>
      <if test="isDelete != null">
        #{isDelete,jdbcType=TINYINT},
      </if>
      <if test="gmtCreate != null">
        #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="gmtModified != null">
        #{gmtModified,jdbcType=TIMESTAMP},
      </if>
      <if test="opTime != null">
        #{opTime,jdbcType=VARCHAR},
      </if>
      <if test="userName != null">
        #{userName,jdbcType=VARCHAR},
      </if>
      <if test="userId != null">
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="instanceName != null">
        #{instanceName,jdbcType=VARCHAR},
      </if>
      <if test="instanceId != null">
        #{instanceId,jdbcType=INTEGER},
      </if>
      <if test="msSchemaName != null">
        #{msSchemaName,jdbcType=VARCHAR},
      </if>
      <if test="dbId != null">
        #{dbId,jdbcType=INTEGER},
      </if>
      <if test="logic != null">
        #{logic,jdbcType=VARCHAR},
      </if>
      <if test="sqlType != null">
        #{sqlType,jdbcType=VARCHAR},
      </if>
      <if test="execState != null">
        #{execState,jdbcType=VARCHAR},
      </if>
      <if test="affectRows != null">
        #{affectRows,jdbcType=INTEGER},
      </if>
      <if test="elapsedTime != null">
        #{elapsedTime,jdbcType=INTEGER},
      </if>
      <if test="remark != null">
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="msSql != null">
        #{msSql,jdbcType=LONGVARCHAR},
      </if>
      <if test="sqlSource != null">
        #{sqlSource,jdbcType=VARCHAR},
      </if>
      <if test="hash != null">
        #{hash,jdbcType=VARCHAR},
      </if>
      <if test="sqlInsightDbUserName != null">
        #{sqlInsightDbUserName,jdbcType=VARCHAR},
      </if>
      <if test="sqlInsightUserIp != null">
        #{sqlInsightUserIp,jdbcType=VARCHAR},
      </if>
      <if test="applicationUserName != null">
        #{applicationUserName,jdbcType=VARCHAR},
      </if>
      <if test="globalTraceId != null">
        #{globalTraceId,jdbcType=VARCHAR},
      </if>
      <if test="parentSegmentId != null">
        #{parentSegmentId,jdbcType=VARCHAR},
      </if>
      <if test="currentSegmentId != null">
        #{currentSegmentId,jdbcType=VARCHAR},
      </if>
      <if test="operationName != null">
        #{operationName,jdbcType=VARCHAR},
      </if>
      <if test="msTableName != null">
        #{msTableName,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.mingshi.skyflying.domain.MsAuditLogDo">
    update ms_audit_log
    <set>
      <if test="isDelete != null">
        is_delete = #{isDelete,jdbcType=TINYINT},
      </if>
      <if test="gmtCreate != null">
        gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="gmtModified != null">
        gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
      </if>
      <if test="opTime != null">
        op_time = #{opTime,jdbcType=VARCHAR},
      </if>
      <if test="userName != null">
        user_name = #{userName,jdbcType=VARCHAR},
      </if>
      <if test="userId != null">
        user_id = #{userId,jdbcType=INTEGER},
      </if>
      <if test="instanceName != null">
        instance_name = #{instanceName,jdbcType=VARCHAR},
      </if>
      <if test="instanceId != null">
        instance_id = #{instanceId,jdbcType=INTEGER},
      </if>
      <if test="msSchemaName != null">
        ms_schema_name = #{msSchemaName,jdbcType=VARCHAR},
      </if>
      <if test="dbId != null">
        db_id = #{dbId,jdbcType=INTEGER},
      </if>
      <if test="logic != null">
        logic = #{logic,jdbcType=VARCHAR},
      </if>
      <if test="sqlType != null">
        sql_type = #{sqlType,jdbcType=VARCHAR},
      </if>
      <if test="execState != null">
        exec_state = #{execState,jdbcType=VARCHAR},
      </if>
      <if test="affectRows != null">
        affect_rows = #{affectRows,jdbcType=INTEGER},
      </if>
      <if test="elapsedTime != null">
        elapsed_time = #{elapsedTime,jdbcType=INTEGER},
      </if>
      <if test="remark != null">
        remark = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="msSql != null">
        ms_sql = #{msSql,jdbcType=LONGVARCHAR},
      </if>
      <if test="sqlSource != null">
        sql_source = #{sqlSource,jdbcType=VARCHAR},
      </if>
      <if test="hash != null">
        hash = #{hash,jdbcType=VARCHAR},
      </if>
      <if test="sqlInsightDbUserName != null">
        sql_insight_db_user_name = #{sqlInsightDbUserName,jdbcType=VARCHAR},
      </if>
      <if test="sqlInsightUserIp != null">
        sql_insight_user_ip = #{sqlInsightUserIp,jdbcType=VARCHAR},
      </if>
      <if test="applicationUserName != null">
        application_user_name = #{applicationUserName,jdbcType=VARCHAR},
      </if>
      <if test="sqlInsightUserIp != null">
        global_trace_id = #{globalTraceId,jdbcType=VARCHAR},
      </if>
      <if test="parentSegmentId != null">
        parent_segment_id = #{parentSegmentId,jdbcType=VARCHAR},
      </if>
      <if test="currentSegmentId != null">
        current_segment_id = #{currentSegmentId,jdbcType=VARCHAR},
      </if>
      <if test="operationName != null">
        operation_name = #{operationName,jdbcType=VARCHAR},
      </if>
      <if test="msTableName != null">
        ms_table_name = #{msTableName,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateBatch" parameterType="java.util.List">
    update ms_audit_log
    <trim prefix="set" suffixOverrides=",">
      <trim prefix="application_user_name = case" suffix="end,">
        <foreach collection="list" item="item" index="index">
          <if test="item.globalTraceId != null">
            when global_trace_id=#{item.globalTraceId}  then #{item.applicationUserName}
          </if>
        </foreach>
      </trim>
    </trim>
    where global_trace_id in
    <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
      #{item.globalTraceId}
    </foreach>
    and application_user_name is null
  </update>
</mapper>
