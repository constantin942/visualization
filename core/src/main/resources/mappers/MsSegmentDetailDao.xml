<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mingshi.skyflying.dao.MsSegmentDetailDao">
  <resultMap id="BaseResultMap" type="com.mingshi.skyflying.common.domain.MsSegmentDetailDo">
    <id column="id" jdbcType="INTEGER" property="id"/>
    <result column="user_name" jdbcType="VARCHAR" property="userName"/>
    <result column="global_trace_id" jdbcType="VARCHAR" property="globalTraceId"/>
    <result column="parent_segment_id" jdbcType="VARCHAR" property="parentSegmentId"/>
    <result column="operation_name" jdbcType="VARCHAR" property="operationName"/>
    <result column="current_segment_id" jdbcType="VARCHAR" property="currentSegmentId"/>
    <result column="gmt_create" jdbcType="TIMESTAMP" property="gmtCreate"/>
    <result column="gmt_modified" jdbcType="TIMESTAMP" property="gmtModified"/>
    <result column="is_delete" jdbcType="TINYINT" property="isDelete"/>
    <result column="span_id" jdbcType="INTEGER" property="spanId"/>
    <result column="component" jdbcType="VARCHAR" property="component"/>
    <result column="service_code" jdbcType="VARCHAR" property="serviceCode"/>
    <result column="peer" jdbcType="VARCHAR" property="peer"/>
    <result column="endpoint_name" jdbcType="VARCHAR" property="endpointName"/>
    <result column="start_time" jdbcType="TIMESTAMP" property="startTime"/>
    <result column="service_instance_name" jdbcType="VARCHAR" property="serviceInstanceName"/>
    <result column="end_time" jdbcType="TIMESTAMP" property="endTime"/>
    <result column="parent_span_id" jdbcType="INTEGER" property="parentSpanId"/>
    <result column="db_type" jdbcType="VARCHAR" property="dbType"/>
    <result column="db_instance" jdbcType="VARCHAR" property="dbInstance"/>
    <result column="db_user_name" jdbcType="VARCHAR" property="dbUserName"/>
    <result column="ms_table_name" jdbcType="VARCHAR" property="msTableName"/>
    <result column="operation_type" jdbcType="VARCHAR" property="operationType"/>
    <result column="user_portrait_flag_by_visited_time" jdbcType="TINYINT" property="userPortraitFlagByVisitedTime"/>
    <result column="user_portrait_flag_by_visited_table_everyday" jdbcType="TINYINT"
            property="userPortraitFlagByVisitedTableEveryday"/>
    <result column="db_statement" jdbcType="LONGVARCHAR" property="dbStatement"/>
    <result column="token" jdbcType="VARCHAR" property="token"/>
    <result column="user_login_ip" jdbcType="VARCHAR" property="userLoginIp"/>
  </resultMap>
  <sql id="Base_Column_List">
    id
    , user_login_ip, user_name,token, global_trace_id, parent_segment_id, operation_name, current_segment_id,
    gmt_create, gmt_modified, is_delete, span_id, component, service_code, peer, endpoint_name,
    start_time, service_instance_name, end_time, parent_span_id, db_type, db_instance,operation_type,
    ms_table_name,db_user_name,user_portrait_flag_by_visited_time,user_portrait_flag_by_visited_table_everyday
  </sql>
  <sql id="Blob_Column_List">
    db_statement
  </sql>
  <select id="selectAllUserName" resultType="java.lang.String">
    SELECT DISTINCT user_name
    FROM `ms_segment_detail`
    where user_name is not null
  </select>
  <select id="selectAllMsTableName" resultType="java.lang.String">
    SELECT DISTINCT ms_table_name
    FROM `ms_segment_detail`
  </select>
  <select id="selectAllMsTableNameDbInstancePeer" resultType="java.util.Map">
    select ms_table_name as msTableName, db_instance as dbInstance, peer
    from ms_segment_detail
    where ms_table_name is not null
    group by ms_table_name, db_instance, peer
  </select>
  <select id="selectAllInstanceName" resultType="java.lang.String">
    SELECT DISTINCT db_instance
    FROM `ms_segment_detail`
    where db_instance is not null
  </select>
  <select id="selectByTokenUserNameGlobalTraceIdIsNotNull" parameterType="java.lang.String" resultMap="BaseResultMap">
    select user_name, token, global_trace_id
    from ms_segment_detail
    where token is not null
      and user_name is not null
      and global_trace_id is not null
      and start_time <![CDATA[ >= ]]> #{startTime}
  </select>
  <select id="selectCountAllOld" parameterType="java.util.Map" resultType="java.lang.Long">
    select count(*)
    from (select global_trace_id
    from ms_segment_detail
    where user_name is not null and user_name is not null and ms_table_name is not null and operation_name != 'null'
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="operationType != null and  operationType != null   ">
      and operation_type = #{operationType}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
    group by global_trace_id) as t1;
  </select>
  <select id="selectCountAllNew" parameterType="java.util.Map" resultType="java.lang.Long">
    select count(*)
    from (select global_trace_id
    from ms_segment_detail
    where operation_name != 'null'
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="operationType != null and  operationType != null   ">
      and operation_type = #{operationType}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
    group by global_trace_id) as t1;
  </select>
  <select id="selectCountAllFileOutputAndSendEmail" parameterType="java.util.Map" resultType="java.lang.Long">
    select count(*)
    from (select global_trace_id
    from ms_segment_detail
    where user_name is not null
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="operationType != null and  operationType != null   ">
      and operation_type = #{operationType}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
    group by global_trace_id) as t1;
  </select>
  <select id="selectAllOld" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select *
    from ms_segment_detail
    where user_name is not null and global_trace_id in ( select t1.* from (select global_trace_id from ms_segment_detail
    where db_type != 'url' and user_name is not null and ms_table_name is not null and operation_name != 'null'
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="operationType != null and  operationType != null   ">
      and operation_type = #{operationType}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
    group by global_trace_id order by global_trace_id desc
    <if test="pageNo != null and  pageSize != null   ">
      LIMIT #{pageNo},#{pageSize}
    </if>
    ) as t1 )
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="operationType != null and  operationType != null   ">
      and operation_type = #{operationType}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
    -- 先注释掉，调试获取完整调用链路信息时，会用到；2022-06-14 18:05:20
    and (db_type != 'url')
    and user_name is not null and ms_table_name is not null and operation_name != 'null'
    order by id desc;
    -- 这行代码同时也输出对Redis的操作。
    -- and (db_type != 'url' or db_type is null)
    -- order by id desc;
  </select>
  <select id="selectAllNew" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select *
    from ms_segment_detail
    where global_trace_id in ( select t1.* from (select global_trace_id from ms_segment_detail
    where db_type != 'url' and operation_name != 'null'
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="operationType != null and  operationType != null   ">
      and operation_type = #{operationType}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
    group by global_trace_id order by global_trace_id desc
    <if test="pageNo != null and  pageSize != null   ">
      LIMIT #{pageNo},#{pageSize}
    </if>
    ) as t1 )
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="operationType != null and  operationType != null   ">
      and operation_type = #{operationType}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
    -- 先注释掉，调试获取完整调用链路信息时，会用到；2022-06-14 18:05:20
    -- and (db_type != 'url')
    and operation_name != 'null'
    order by id desc;
  </select>
  <select id="selectAllFileOutputAndSendEmail" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select *
    from ms_segment_detail
    where user_name is not null and global_trace_id in ( select t1.* from (select global_trace_id from ms_segment_detail
    where user_name is not null
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="operationType != null and  operationType != null   ">
      and operation_type = #{operationType}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
    group by global_trace_id order by global_trace_id desc
    <if test="pageNo != null and  pageSize != null   ">
      LIMIT #{pageNo},#{pageSize}
    </if>
    ) as t1 )
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="operationType != null and  operationType != null   ">
      and operation_type = #{operationType}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ <= ]]> #{endTime}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
    -- 先注释掉，调试获取完整调用链路信息时，会用到；2022-06-14 18:05:20
    and (db_type != 'url')
    and user_name is not null
    order by id desc;
    -- 这行代码同时也输出对Redis的操作。
    -- and (db_type != 'url' or db_type is null)
    -- order by id desc;
  </select>
  <select id="selectAllUserNameIsNotNullAndTokeIsNotNull" resultType="java.util.Map">
    select user_name as userName, token
    from ms_segment_detail
    where token is not null
      and user_name is not null
    group by user_name, token
  </select>
  <select id="selectBatchUserNameIsNotNullAndTokeIsNotNull" resultType="java.util.Map">
    SELECT user_name as userName, token FROM ms_segment_detail
    where id in
    <foreach collection="list" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>
  <select id="selectAllId" resultType="java.lang.Integer">
    select id
    from ms_segment_detail
    where token is not null
      and user_name is not null
    group by user_name, token, id
  </select>
  <select id="selectAllUserNameIsNotNullAndVisitedTimeIsZero" parameterType="java.lang.Integer"
          resultMap="BaseResultMap">
    select id,
           user_name,
           start_time,
           global_trace_id,
           user_portrait_flag_by_visited_time,
           user_portrait_flag_by_visited_table_everyday
    from ms_segment_detail
    where is_delete = 0
      and user_name is not null
      and (user_portrait_flag_by_visited_time = 0 or user_portrait_flag_by_visited_time is null)
  </select>
  <select id="selectAllUserNameIsNotNullAndVisitedTableIsZero" parameterType="java.lang.Integer"
          resultMap="BaseResultMap">
    select id,
           user_name,
           start_time,
           ms_table_name,
           global_trace_id,
           operation_type,
           user_portrait_flag_by_visited_table_everyday,
           user_portrait_flag_by_visited_time
    from ms_segment_detail
    where is_delete = 0
      and user_name is not null
      and (user_portrait_flag_by_visited_table_everyday = 0 or user_portrait_flag_by_visited_table_everyday is null)
      and operation_type = 'sql'
      and ms_table_name is not null
  </select>
  <select id="selectAllUserNameIsNotNull" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select id,
           user_name,
           start_time
    from ms_segment_detail
    where user_name is not null
  </select>
  <select id="selectAllUserNameIsNotNullAndTableNameIsNotNull" parameterType="java.lang.Integer"
          resultMap="BaseResultMap">
    select id,
           user_name,
           start_time,
           ms_table_name,
           db_instance,
           db_type
    from ms_segment_detail
    where user_name is not null
      and operation_type = 'sql'
      and ms_table_name is not null
  </select>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List"/>
    ,
    <include refid="Blob_Column_List"/>
    from ms_segment_detail
    where id = #{id,jdbcType=INTEGER}
  </select>
  <select id="selectAllInstanceAndTableName" resultType="com.mingshi.skyflying.common.domain.InstanceTable">
    SELECT DISTINCT db_instance, ms_table_name
    FROM `ms_segment_detail`
    where db_instance is not null
  </select>

  <select id="selectCountsOfUser" resultType="java.lang.Long" parameterType="java.util.Map">
    select count(*) from ms_segment_detail
    where user_name is not null
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="peer != null and  peer != null   ">
      and peer = #{peer}
    </if>
    <if test="dbInstance != null and  dbInstance != null   ">
      and db_instance = #{dbInstance}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
  </select>
  <select id="selectCountsOfUserByPeerAndDbInstanceAndTableName" resultType="java.lang.Long"
          parameterType="java.util.Map">
    select count(*) from ms_segment_detail
    where user_name is not null
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ < ]]> #{endTime}
    </if>
    <if test="peer != null and  peer != null   ">
      and peer = #{peer}
    </if>
    <if test="dbInstance != null and  dbInstance != null   ">
      and db_instance = #{dbInstance}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
  </select>

  <select id="selectCountOfOneUser" resultType="java.lang.Long" parameterType="java.util.Map">
    select count(*)
    from ms_segment_detail
    where user_name = #{userName}
  </select>

  <select id="selectCountOfOneUserByUserName" resultType="java.lang.Long" parameterType="java.lang.String">
    select count(*)
    from ms_segment_detail
    where user_name = #{userName}
      and ms_table_name is not null
  </select>

  <select id="selectLastVisitedTime" resultType="java.lang.String" parameterType="java.util.Map">
    SELECT max(start_time)
    from ms_segment_detail
    where user_name is not null
      and user_name = #{userName}
  </select>

  <select id="selectLastVisitedTimeByUserName" resultType="java.lang.String" parameterType="java.lang.String">
    SELECT start_time
    from ms_segment_detail
    where user_name is not null
      and user_name = #{userName}
    order by start_time desc limit 1
  </select>

  <select id="selectUserUsualAndUnusualData"
          resultType="com.mingshi.skyflying.common.domain.UserUsualAndUnusualVisitedData" parameterType="java.util.Map">
    SELECT user_name, visited_table as visited_data, SUM(visited_count) as visited_count
    FROM `user_portrait_by_visited_table_everyday`
    where user_name is not null
      and user_name = #{userName}
    GROUP BY visited_table
  </select>

  <select id="selectUserUsualAndUnusualDataByUserName" resultType="java.util.Map" parameterType="java.lang.String">
    SELECT ms_table_name as msTableName,
           peer,
           db_instance   as dbInstance
    FROM ms_segment_detail
    WHERE user_name = #{userName}
      AND ms_table_name IS NOT NULL
    GROUP BY ms_table_name, peer, db_instance
    ORDER BY count(ms_table_name) DESC limit 1;
  </select>

  <select id="selectCountsOfAllRecentSevenDays" resultType="java.lang.Long" parameterType="java.util.Map">
    select count(*) from ms_segment_detail
    where user_name is not null and ms_table_name is not null
    <if test="userName != null and  userName != null   ">
      and user_name = #{userName}
    </if>
    <if test="operationType != null and  operationType != null   ">
      and operation_type = #{operationType}
    </if>
    <if test="dbType != null and  dbType != null   ">
      and db_type = #{dbType}
    </if>
    <if test="startTime != null and  startTime != null   ">
      and start_time <![CDATA[ >= ]]> #{startTime}
    </if>
    <if test="endTime != null and  endTime != null   ">
      and end_time <![CDATA[ < ]]> #{endTime}
    </if>
    <if test="msTableName != null and  msTableName != null   ">
      and ms_table_name = #{msTableName}
    </if>
  </select>
  <select id="selectinformationCount" resultType="java.lang.Long">
    select count(*)
    from ms_segment_detail
    where user_name is not null
      and ms_table_name is not null
  </select>
  <select id="selectDbInstanceCount" resultType="java.lang.Long">
    select count(distinct db_instance)
    from ms_segment_detail
    where db_instance is not null
      and user_name is not null
  </select>
  <select id="selectTableCount" resultType="java.lang.Long">
    select count(distinct ms_table_name)
    from ms_segment_detail
    where ms_table_name is not null
  </select>
  <select id="selectTableCountGroupByPeerDbinstanceTableName" resultType="java.util.Map">
    SELECT ms_table_name as msTableName,
           db_instance      dbInstance,
           peer
    FROM ms_segment_detail
    WHERE ms_table_name IS NOT NULL
      and user_name is not null
    GROUP BY ms_table_name,
             db_instance,
             peer
  </select>
  <select id="selectUserCount" resultType="java.lang.Long">
    select count(distinct user_name)
    from ms_segment_detail
    where user_name is not null
      and ms_table_name is not null
  </select>


  <select id="selectAllTableName" resultType="java.lang.String">
    select distinct ms_table_name
    from ms_segment_detail
    where ms_table_name is not null
  </select>

  <select id="selectCountOfOneTable" resultType="java.lang.Long" parameterType="java.lang.String">
    select count(*)
    from ms_segment_detail
    where ms_table_name = #{tableName}
      and user_name is not null
  </select>

  <select id="selectUserNameByToken" resultType="java.lang.String" parameterType="java.lang.String">
    select user_name
    from ms_segment_detail
    where token = #{token}
      and user_name is not null
    order by id asc limit 1
  </select>

  <select id="selectUserNameByGlobalTraceId" resultType="java.lang.String" parameterType="java.lang.String">
    select user_name
    from ms_segment_detail
    where global_trace_id = #{globalTraceId}
      and user_name is not null
    order by id asc limit 1
  </select>

  <select id="selectTableLastVisitedTime" resultType="java.lang.String" parameterType="java.lang.String">
    SELECT start_time
    from ms_segment_detail
    where ms_table_name = #{tableName}
      and user_name is not null
    order by start_time desc limit 1
  </select>

  <select id="selectTableUsualAndUnusualData"
          resultType="com.mingshi.skyflying.common.domain.UserUsualAndUnusualVisitedData"
          parameterType="java.lang.String">
    select ms_table_name as visited_data, count(*) as visited_count, user_name
    from ms_segment_detail
    where ms_table_name = #{tableName,jdbcType=VARCHAR}
      and user_name is not null
    group by user_name
    order by count(*) desc limit 1;
  </select>
  <select id="selectAlarmData" resultType="com.mingshi.skyflying.common.domain.AlarmData">
    SELECT COUNT(*) as alarm_data, match_rule_id
    FROM ms_alarm_information
    where match_rule_id is not NULL
      and update_user_portrait = 0
      and is_delete = 0
    GROUP BY match_rule_id
  </select>

  <select id="selectUserAlarmData" resultType="com.mingshi.skyflying.common.domain.UserAlarmData">
    SELECT count(*) as alarm_count, user_name
    from ms_alarm_information
    where update_user_portrait = 0
      and is_delete = 0
    GROUP BY user_name
  </select>


  <insert id="insertSelectiveBatch" parameterType="java.util.List">
    insert into ms_segment_detail
    (user_login_ip, user_name,token, global_trace_id, parent_segment_id, operation_name, current_segment_id,
    span_id, component, service_code, peer, endpoint_name,
    start_time, service_instance_name, end_time, parent_span_id, db_type, db_instance,
    db_user_name, db_statement, ms_table_name, operation_type, user_portrait_flag_by_visited_time,
    user_portrait_flag_by_visited_table_everyday)
    values
    <foreach collection="list" item="item" index="index" separator=",">
      (
      #{item.userLoginIp,jdbcType=VARCHAR},
      #{item.userName,jdbcType=VARCHAR},
      #{item.token,jdbcType=VARCHAR},
      #{item.globalTraceId,jdbcType=VARCHAR},
      #{item.parentSegmentId,jdbcType=INTEGER},
      #{item.operationName,jdbcType=VARCHAR},
      #{item.currentSegmentId,jdbcType=INTEGER},
      #{item.spanId,jdbcType=INTEGER},
      #{item.component,jdbcType=INTEGER},
      #{item.serviceCode,jdbcType=VARCHAR},
      #{item.peer,jdbcType=VARCHAR},
      #{item.endpointName,jdbcType=VARCHAR},
      #{item.startTime,jdbcType=TIMESTAMP},
      #{item.serviceInstanceName,jdbcType=VARCHAR},
      #{item.endTime,jdbcType=TIMESTAMP},
      #{item.parentSpanId,jdbcType=INTEGER},
      #{item.dbType,jdbcType=VARCHAR},
      #{item.dbInstance,jdbcType=VARCHAR},
      #{item.dbUserName,jdbcType=VARCHAR},
      #{item.dbStatement,jdbcType=VARCHAR},
      #{item.msTableName,jdbcType=VARCHAR},
      #{item.operationType,jdbcType=VARCHAR},
      #{item.userPortraitFlagByVisitedTime,jdbcType=INTEGER},
      #{item.userPortraitFlagByVisitedTableEveryday,jdbcType=INTEGER}
      )
    </foreach>
  </insert>
  <insert id="insertSelective" parameterType="com.mingshi.skyflying.common.domain.MsSegmentDetailDo">
    insert into ms_segment_detail
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="userName != null">
        user_name,
      </if>
      <if test="userLoginIp != null">
        user_login_ip,
      </if>
      <if test="globalTraceId != null">
        global_trace_id,
      </if>
      <if test="parentSegmentId != null">
        parent_segment_id,
      </if>
      <if test="operationName != null">
        operation_name,
      </if>
      <if test="currentSegmentId != null">
        current_segment_id,
      </if>
      <if test="gmtCreate != null">
        gmt_create,
      </if>
      <if test="gmtModified != null">
        gmt_modified,
      </if>
      <if test="isDelete != null">
        is_delete,
      </if>
      <if test="spanId != null">
        span_id,
      </if>
      <if test="component != null">
        component,
      </if>
      <if test="serviceCode != null">
        service_code,
      </if>
      <if test="peer != null">
        peer,
      </if>
      <if test="endpointName != null">
        endpoint_name,
      </if>
      <if test="startTime != null">
        start_time,
      </if>
      <if test="serviceInstanceName != null">
        service_instance_name,
      </if>
      <if test="endTime != null">
        end_time,
      </if>
      <if test="parentSpanId != null">
        parent_span_id,
      </if>
      <if test="dbType != null">
        db_type,
      </if>
      <if test="dbInstance != null">
        db_instance,
      </if>
      <if test="dbUserName != null">
        db_user_name,
      </if>
      <if test="dbStatement != null">
        db_statement,
      </if>
      <if test="msTableName != null">
        ms_table_name,
      </if>
      <if test="operationType != null">
        operation_type,
      </if>
      <if test="userPortraitFlagByVisitedTime != null">
        user_portrait_flag_by_visited_time,
      </if>
      <if test="userPortraitFlagByVisitedTableEveryday != null">
        user_portrait_flag_by_visited_table_everyday,
      </if>
      <if test="token != null">
        token,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=INTEGER},
      </if>
      <if test="userName != null">
        #{userName,jdbcType=VARCHAR},
      </if>
      <if test="userLoginIp != null">
        #{userLoginIp,jdbcType=VARCHAR},
      </if>
      <if test="globalTraceId != null">
        #{globalTraceId,jdbcType=VARCHAR},
      </if>
      <if test="parentSegmentId != null">
        #{parentSegmentId,jdbcType=VARCHAR},
      </if>
      <if test="operationName != null">
        #{operationName,jdbcType=VARCHAR},
      </if>
      <if test="currentSegmentId != null">
        #{currentSegmentId,jdbcType=VARCHAR},
      </if>
      <if test="gmtCreate != null">
        #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="gmtModified != null">
        #{gmtModified,jdbcType=TIMESTAMP},
      </if>
      <if test="isDelete != null">
        #{isDelete,jdbcType=TINYINT},
      </if>
      <if test="spanId != null">
        #{spanId,jdbcType=INTEGER},
      </if>
      <if test="component != null">
        #{component,jdbcType=VARCHAR},
      </if>
      <if test="serviceCode != null">
        #{serviceCode,jdbcType=VARCHAR},
      </if>
      <if test="peer != null">
        #{peer,jdbcType=VARCHAR},
      </if>
      <if test="endpointName != null">
        #{endpointName,jdbcType=VARCHAR},
      </if>
      <if test="startTime != null">
        #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="serviceInstanceName != null">
        #{serviceInstanceName,jdbcType=VARCHAR},
      </if>
      <if test="endTime != null">
        #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="parentSpanId != null">
        #{parentSpanId,jdbcType=INTEGER},
      </if>
      <if test="dbType != null">
        #{dbType,jdbcType=VARCHAR},
      </if>
      <if test="dbInstance != null">
        #{dbInstance,jdbcType=VARCHAR},
      </if>
      <if test="dbUserName != null">
        #{dbUserName,jdbcType=VARCHAR},
      </if>
      <if test="dbStatement != null">
        #{dbStatement,jdbcType=LONGVARCHAR},
      </if>
      <if test="msTableName != null">
        #{msTableName,jdbcType=VARCHAR},
      </if>
      <if test="operationType != null">
        #{operationType,jdbcType=VARCHAR},
      </if>
      <if test="userPortraitFlagByVisitedTime != null">
        #{userPortraitFlagByVisitedTime,jdbcType=VARCHAR},
      </if>
      <if test="userPortraitFlagByVisitedTableEveryday != null">
        #{userPortraitFlagByVisitedTableEveryday,jdbcType=VARCHAR},
      </if>
      <if test="token != null">
        #{token,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateBatch" parameterType="java.util.List">
    <foreach collection="list" item="item" index="index" open="" close="" separator=";">
      update ms_segment_detail
      <set>
        <if test="item.userName != null and item.userName != ''">
          user_name = #{item.userName},
        </if>
      </set>
      where global_trace_id=#{item.globalTraceId} and user_name is null
    </foreach>
  </update>
  <update id="updateBatchByToken" parameterType="java.util.List">
    <foreach collection="list" item="item" index="index" open="" close="" separator=";">
      update ms_segment_detail
      set user_name = #{item.userName}
      where token=#{item.token} and user_name is null
    </foreach>
  </update>
  <update id="updateBatchById" parameterType="java.util.List">
    <foreach collection="list" item="item" index="index" open="" close="" separator=";">
      update ms_segment_detail
      <set>
        is_delete = 0,
        <if test="item.userPortraitFlagByVisitedTime != null and item.userPortraitFlagByVisitedTime != ''">
          user_portrait_flag_by_visited_time = #{item.userPortraitFlagByVisitedTime},
        </if>
        <if
          test="item.userPortraitFlagByVisitedTableEveryday != null and item.userPortraitFlagByVisitedTableEveryday != ''">
          user_portrait_flag_by_visited_table_everyday = #{item.userPortraitFlagByVisitedTableEveryday},
        </if>
      </set>
      where id=#{item.id}
    </foreach>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.mingshi.skyflying.common.domain.MsSegmentDetailDo">
    update ms_segment_detail
    <set>
      <if test="userLoginIp != null">
        user_login_ip = #{userLoginIp,jdbcType=VARCHAR},
      </if>
      <if test="userName != null">
        user_name = #{userName,jdbcType=VARCHAR},
      </if>
      <if test="token != null">
        token = #{token,jdbcType=VARCHAR},
      </if>
      <if test="globalTraceId != null">
        global_trace_id = #{globalTraceId,jdbcType=VARCHAR},
      </if>
      <if test="parentSegmentId != null">
        parent_segment_id = #{parentSegmentId,jdbcType=VARCHAR},
      </if>
      <if test="operationName != null">
        operation_name = #{operationName,jdbcType=VARCHAR},
      </if>
      <if test="currentSegmentId != null">
        current_segment_id = #{currentSegmentId,jdbcType=VARCHAR},
      </if>
      <if test="gmtCreate != null">
        gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="gmtModified != null">
        gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
      </if>
      <if test="isDelete != null">
        is_delete = #{isDelete,jdbcType=TINYINT},
      </if>
      <if test="spanId != null">
        span_id = #{spanId,jdbcType=INTEGER},
      </if>
      <if test="component != null">
        component = #{component,jdbcType=VARCHAR},
      </if>
      <if test="serviceCode != null">
        service_code = #{serviceCode,jdbcType=VARCHAR},
      </if>
      <if test="peer != null">
        peer = #{peer,jdbcType=VARCHAR},
      </if>
      <if test="endpointName != null">
        endpoint_name = #{endpointName,jdbcType=VARCHAR},
      </if>
      <if test="startTime != null">
        start_time = #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="serviceInstanceName != null">
        service_instance_name = #{serviceInstanceName,jdbcType=VARCHAR},
      </if>
      <if test="endTime != null">
        end_time = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="parentSpanId != null">
        parent_span_id = #{parentSpanId,jdbcType=INTEGER},
      </if>
      <if test="dbType != null">
        db_type = #{dbType,jdbcType=VARCHAR},
      </if>
      <if test="dbInstance != null">
        db_instance = #{dbInstance,jdbcType=VARCHAR},
      </if>
      <if test="dbUserName != null">
        db_user_name = #{dbUserName,jdbcType=VARCHAR},
      </if>
      <if test="dbStatement != null">
        db_statement = #{dbStatement,jdbcType=LONGVARCHAR},
      </if>
      <if test="msTableName != null">
        ms_table_name = #{msTableName,jdbcType=VARCHAR},
      </if>
      <if test="operationType != null">
        operation_type = #{operationType,jdbcType=VARCHAR},
      </if>
      <if test="userPortraitFlagByVisitedTime != null">
        user_portrait_flag_by_visited_time = #{userPortraitFlagByVisitedTime,jdbcType=VARCHAR},
      </if>
      <if test="userPortraitFlagByVisitedTableEveryday != null">
        user_portrait_flag_by_visited_table_everyday = #{userPortraitFlagByVisitedTableEveryday,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
</mapper>
